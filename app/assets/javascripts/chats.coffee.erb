# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/
$(document).ready =>
  username = ''
  roomId = $('.chat-box').data('room-id')

  # Format date function
  formatDate = (dateString) ->
    date = new Date(dateString)
    day = String(date.getDate()).padStart(2, '0')
    month = String(date.getMonth() + 1).padStart(2, '0')
    year = date.getFullYear()
    hours = String(date.getHours()).padStart(2, '0')
    minutes = String(date.getMinutes()).padStart(2, '0')
    "#{day}/#{month}/#{year} #{hours}:#{minutes}"

  updateChat = (data) ->
    timestamp = if data.created_at then formatDate(data.created_at) else formatDate(new Date())
    $('.chat-box').append """
      <div class="col-12">
        <div class="chat bg-secondary d-inline-block text-left text-white mb-2">
          <div class="chat-bubble">
            <small class="chat-username">#{data.username}</small>
            <small class="chat-timestamp"> â€¢ #{timestamp}</small>
            <p class="m-0 chat-message">#{data.message}</p>
          </div>
        </div>
      </div>
    """
    # Auto scroll to bottom
    $('.chat-box').scrollTop($('.chat-box')[0].scrollHeight)
    return

  # Event handler untuk input username
  $('.sidebar-form').on 'keypress', (event) ->
    if event.which == 13 or event.keyCode == 13
      event.preventDefault()
      username = $(this).val().trim()
      
      if username.length > 0
        $('.username-display').text(username)
        $('#username').val(username)
        $('.username').removeClass('d-none')
        $('.username-input-wrapper').hide()
        $('#message').prop('disabled', false)
        $('#message').focus()
      else
        alert('Please enter a username')
    return

  # Prevent default form submission
  $('#chat-form').on 'submit', (event) ->
    event.preventDefault()
    event.stopPropagation()
    
    # Validasi: pastikan username sudah diisi
    currentUsername = $('#username').val()
    if !currentUsername or currentUsername.trim().length == 0
      alert('Please enter your username first before sending a message!')
      $('.sidebar-form').focus()
      return false
    
    formData = $(this).serialize()
    roomId = $('.chat-box').data('room-id')
    
    $.ajax
      url: "/rooms/#{roomId}/chats.json"
      type: 'POST'
      data: formData
      dataType: 'json'
      success: (data) ->
        console.log('Message sent successfully')
        $('#message').val('')
        $('#message').focus()
      error: (xhr, status, error) ->
        console.error('Error sending message:', error)
        alert('Failed to send message. Please try again.')
    
    return false

  # Submit form ketika Enter ditekan pada message input
  $('#message').on 'keypress', (event) ->
    if event.which == 13 or event.keyCode == 13
      event.preventDefault()
      
      # Validasi: pastikan username sudah diisi
      currentUsername = $('#username').val()
      if !currentUsername or currentUsername.trim().length == 0
        alert('Please enter your username first before sending a message!')
        $('.sidebar-form').focus()
        return false
      
      if $(this).val().trim().length > 0
        $('#chat-form').submit()
    return

  # Tambahkan event handler untuk klik pada message input jika belum ada username
  $('#message').on 'click focus', (event) ->
    currentUsername = $('#username').val()
    if !currentUsername or currentUsername.trim().length == 0
      event.preventDefault()
      alert('Please enter your username in the sidebar first!')
      $('.sidebar-form').focus()
      return false
    return

  # Pusher subscription - hanya jika ada roomId
  if roomId
    Pusher.logToConsole = true
    pusher = new Pusher('62cd985e9d8238ed4033',
      cluster: 'ap1'
      encrypted: true)
    channel = pusher.subscribe("chat-room-#{roomId}")
    channel.bind 'new', (data) ->
      console.log('Received message from Pusher:', data)
      updateChat(data)
      return

  return


